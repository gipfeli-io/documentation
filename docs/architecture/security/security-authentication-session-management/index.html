<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-architecture/security/security-authentication-session-management">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Authentication &amp; Session Management | gipfeli.io</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.gipfeli.io/docs/architecture/security/security-authentication-session-management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Authentication &amp; Session Management | gipfeli.io"><meta data-rh="true" name="description" content="Authentication is the process of verifying that an individual, entity or website is whom it claims to be."><meta data-rh="true" property="og:description" content="Authentication is the process of verifying that an individual, entity or website is whom it claims to be."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.gipfeli.io/docs/architecture/security/security-authentication-session-management"><link data-rh="true" rel="alternate" href="https://www.gipfeli.io/docs/architecture/security/security-authentication-session-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.gipfeli.io/docs/architecture/security/security-authentication-session-management" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/meeting-notes/rss.xml" title="gipfeli.io RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/meeting-notes/atom.xml" title="gipfeli.io Atom Feed"><link rel="stylesheet" href="/assets/css/styles.60b9c991.css">
<link rel="preload" href="/assets/js/runtime~main.00d95ec8.js" as="script">
<link rel="preload" href="/assets/js/main.cadd4a1f.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="gipfeli.io Docs" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="gipfeli.io Docs" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">gipfeli.io</b></a><a class="navbar__item navbar__link" href="/general/">General</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Technical Docs</a><a class="navbar__item navbar__link" href="/meeting-notes">Recent Meeting Notes</a><a class="navbar__item navbar__link" href="/meeting-notes/archive">Meeting Notes Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/gipfeli-io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current,docs-general-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/setup">Setup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/domain/basics">Domain</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/architecture/basics">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/basics">Basics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/api-architecture">API Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/frontend-architecture">Frontend Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/architecture/security/security-general">Security</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/security/security-general">General</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/architecture/security/security-authentication-session-management">Authentication &amp; Session Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/architecture/security/security-authorization">Authorization</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/infrastructure/basics">Infrastructure</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/design/basics">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/guidelines/branching-strategy">Guidelines</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Security</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Authentication &amp; Session Management</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Authentication &amp; Session Management</h1></header><blockquote><p><strong>Authentication</strong> is the process of verifying that an individual, entity or website is whom it claims to be.
Authentication in the context of web applications is commonly performed by submitting a username or ID and one or more
items of private information that only a given user should know.</p><p><strong>Session Management</strong> is a process by which a server maintains the state of an entity interacting with it. This is
required for a server to remember how to react to subsequent requests throughout a transaction. Sessions are
maintained
on the server by a session identifier which can be passed back and forth between the client and server when
transmitting
and receiving requests. Sessions should be unique per user and computationally very difficult to predict.<!-- -->[...]</p><p>— <a href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html" target="_blank" rel="noopener noreferrer">OSWASP Authentication Cheat Sheet</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="general">General<a class="hash-link" href="#general" title="Direct link to heading">​</a></h2><p>As seen from the quotes above, there are two main conceptual components: <strong>authentication</strong> and <strong>session management</strong>.
These two play together and ultimately serve the purpose to authenticate a user. All protected routes can only be
accessed if a user is authenticated, which means they must (a) be logged-in with their username and password and (b)
have a valid session that is not yet expired.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentication">Authentication<a class="hash-link" href="#authentication" title="Direct link to heading">​</a></h3><p>We are using a JWT-based authentication flow. Whenever a user logs in, the following sequence of event happens:</p><img loading="lazy" src="https://www.plantuml.com/plantuml/png/lLBBJiD03BplLrZYaafyGNAWFDGFe4AStSHfLYJhOZkaIFbul6bLSk7ASSUpC-D7sAgXs3Zq8SmxuMIKcZaiO2ZVb0J8CL6W0MCFc1eueUh4qYmF7Gz3D8MMPQZ2VFUOB7wEzDv5e_a9wuz5hzn5vuvPRehMNNyPDLVPcA11mmCgLI6sK5oSpr5D7pPW7IKelaatWNebA19l0a3vIZPA0X9XgHnOTU3LVSVJRqsDJy5BiVqpPJP-OLBeK3jgxbSnRpqFQBNdnoy7C-t_qfNFGcW428acK5ADdFBat7yrlHij0TQriy3O1PPb8GYrGjgjC5bILkljbtjZeGj7iqFFDVOve-2HBZSWN9EFmDZJdCtdStJlfOkmTP5yK3y0" alt="Authentication flow" class="img_ev3q"><p>In order to prevent enumeration attacks, we do not raise detailed errors - instead, a generic <code>404 - Not found</code> is
raised, even if a valid user with an invalid password is entered. The JWT tokens are encrypted using a configurable
secret. They have different content, lifetime and purpose:</p><ul><li><strong>Access token:</strong> This token contains an expiration date, issue date as well as the user&#x27;s role, ID and email. Its
validity period is configurable and should be configured to be very short.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Encrypted: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGdpcGZlbGkuaW8iLCJzdWIiOiI3NmIyZDE2MS1iY2YxLTQ1ZmItODkyMC02YWE2NDMxYzcxMWQiLCJyb2xlIjowLCJpYXQiOjE2NjIyODI2NjAsImV4cCI6MTY2MjI4Mjc4MH0.5CQLeT_Q14gVowgAQE6tuHulH2ORl1gsOIvISY8gxyg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Decrypted payload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;email&quot;: &quot;admin@gipfeli.io&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;sub&quot;: &quot;76b2d161-bcf1-45fb-8920-6aa6431c711d&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;role&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;iat&quot;: 1662282660,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;exp&quot;: 1662282780</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Refresh token:</strong> This token contains an expiration date, issue date as well as the session ID. Its validity period is
configurable and should be configured to be long.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Encrypted: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uSWQiOiI3N2VmZWIxNi03M2FiLTRlZWUtODdiMy03NDhiZDhmMGI5MDciLCJpYXQiOjE2NjIyODI5MzQsImV4cCI6MTY2MjI4MzIzNH0.fAVWdNl67yv5uHHiehkQiBjJDhYLCCC2fHI1QRgKrMU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Decrypted payload:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;sessionId&quot;: &quot;77efeb16-73ab-4eee-87b3-748bd8f0b907&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;iat&quot;: 1662282934,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;exp&quot;: 1662283234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="performing-authenticated-requests">Performing authenticated requests<a class="hash-link" href="#performing-authenticated-requests" title="Direct link to heading">​</a></h3><p>Once a user is logged in, authenticated requests can be performed by sening the (encrypted) access token as
Authorization Bearer header:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGdpcGZlbGkuaW8iLCJzdWIiOiI3NmIyZDE2MS1iY2YxLTQ1ZmItODkyMC02YWE2NDMxYzcxMWQiLCJyb2xlIjowLCJpYXQiOjE2NjIyMDY3NzgsImV4cCI6MTY2MjIwNzM3OH0.p2WvvDw8EhC7vnzGu8draL3aJm-LZNcXvKDMpeu11RQ</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The backend verifies the integrity of the token and its validity and passes the request.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="refreshing-the-access-token">Refreshing the access token<a class="hash-link" href="#refreshing-the-access-token" title="Direct link to heading">​</a></h3><p>The access token should have a short validity period because it authenticates the user. In order to refresh its
validity, the refresh token is used. The refresh token is tied to a session ID. Before the access token expires, a
request to the dedicated refresh endpoint should be made. Instead of the access token in the Authorization header, the
refresh token is used. The backend verifies the token and checks whether the included session ID exists and is still
valid. If so, it creates a new access token and a new refresh token and returns them. From this point on, the validity
is extended again.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logout">Logout<a class="hash-link" href="#logout" title="Direct link to heading">​</a></h3><p>The logout endpoint removes the session from the database. At this moment, no refresh requests can be made. See below
for issues.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-details">Implementation details<a class="hash-link" href="#implementation-details" title="Direct link to heading">​</a></h3><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Backend implementation</summary><div><div class="collapsibleContent_i85q"><div><p>Nest uses the concept of <a href="https://docs.nestjs.com/guards" target="_blank" rel="noopener noreferrer">guards</a> which intercept any request before they actually reach the route handler. Under the hood, each guard uses <a href="https://www.passportjs.org/" target="_blank" rel="noopener noreferrer">passport.js</a> strategies which define what they check:</p><li><strong>Local Strategy:</strong> Used for the login. This strategy takes a user identifier (here: email) and a password from the request body and uses the <code>AuthService</code> to verify whether this user with the given password exists. If succesful, the request handler takes over.</li><li><strong>JWT Strategy:</strong> Used for protected routes. This strategy takes an encrypted JWT from the Authorization header and verifies its integrity and expiry. If it is a valid JWT (i.e. encrypted with our secret) and an access token (i.e. containing the access token params) and still valid, allows the request.</li><li><strong>Refresh JWT Strategy:</strong> Used for the refresh route. This strategy takes an encrypted JWT from the Authorization header and verifies its integrity and expiry. If it is a valid JWT (i.e. encrypted with our secret) and a refresh token (i.e. containing the refresh token params) and still valid, allows the request.</li><li><strong>Token bearer Strategy:</strong> Used for the media cleanup. This strategy takes a secret submitted via Authorization header and checks whether it matches the specified secret in the .env file. If so, allows the request.</li></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Frontend implementation</summary><div><div class="collapsibleContent_i85q"><div><p>The frontend performs requests to the backend. Once a login request is made, it stores the access and refresh tokens in the localstorage. The following components are performing authentication-related tasks:</p><li><strong>Authentication Provider:</strong> Provides an <code>AuthenticationContext</code>, accessible via <code>useAuth()</code> hook. Wrapped around all routes, it allows pages to check for the current authentication state. Upon login, the login page performs the actions in the context required to store the tokens, after which point the frontend is in an authenticated state. This provider also registers an interval hook that periodically checks whether the access token is still valid. If the validity period goes below a certain treshold, the provider performs a refresh request in the background and updates the tokens. This also happens when a user reloads the page - upon initialization, the tokens are checked and refreshed, if need be. This allows the users to log-in and stay logged-in for extended periods of time, while guaranteeing that the tokens are always valid. Finally, when a user logs out, the local storage is purged.</li><li><strong>RequireAuth component:</strong> This react component can be wrapped around other components (e.g. inside a page). It uses the aforementioned <code>useAuth()</code> to check whether the user is logged in. If not, it redirects to the login page.</li><li><strong>Services:</strong> Frontend services that handle requests to the backend get the corresponding token injected during initialization. They add this Authorization header and perform requests to the backend.</li></div></div></div></details><h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations-known-issues-and-outlook">Limitations, known issues and outlook<a class="hash-link" href="#limitations-known-issues-and-outlook" title="Direct link to heading">​</a></h2><p>See also <a href="/general/lessons-learned">lessons learned</a>.</p><p>Unfortunately, Nest does not provide a fully-fledged authentication flow, while providers such as Auth0 are very
expensive. This is why we implemented the flow ourselves. While it does work, it has two important issues:</p><ul><li><strong>Over-engineered:</strong> In its current state, it is a bit overengineered. In fact, we would not require any JWTs and
refresh flows, because we could just return the session ID (or a secret attached to the session ID) and store this for
the Bearer token. We could then check on each request in a corresponding guard whether the supplied secret matches a
valid session. However, this would mean that users are <strong>always</strong> logged out when the session ends, because the tokens
cannot be refreshed. This is why we decided to have a refresh flow.</li><li><strong>Tokens cannot be revoked:</strong> A major issue is that we only check for the session ID in the refresh flow. This means
that when a user logs out, their access token might still be valid for a certain amount of time, before its validity
period has expired. If a user were to logout and retain their access token, they could still perform authenticated
requests. This issue is mitigated in part by the validity period (which should be very low for the access token), but
it might be a security issue nonetheless.</li></ul><p>In the end, we realized that we probably should go for an authentication provider like Auth0 nonetheless. This is why we
did not remove the whole refresh token flow, because we are already well-prepared for implementing the OAuth flows.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/architecture/security/security-general"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">General</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/architecture/security/security-authorization"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Authorization</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#general" class="table-of-contents__link toc-highlight">General</a><ul><li><a href="#authentication" class="table-of-contents__link toc-highlight">Authentication</a></li><li><a href="#performing-authenticated-requests" class="table-of-contents__link toc-highlight">Performing authenticated requests</a></li><li><a href="#refreshing-the-access-token" class="table-of-contents__link toc-highlight">Refreshing the access token</a></li><li><a href="#logout" class="table-of-contents__link toc-highlight">Logout</a></li><li><a href="#implementation-details" class="table-of-contents__link toc-highlight">Implementation details</a></li></ul></li><li><a href="#limitations-known-issues-and-outlook" class="table-of-contents__link toc-highlight">Limitations, known issues and outlook</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 gipfeli.io<br>Built with <a href="https://docusaurus.io/" title="Docusaurus">Docusaurus</a> | Illustrations by <a href="https://undraw.co/" title="Undraw">unDraw</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.00d95ec8.js"></script>
<script src="/assets/js/main.cadd4a1f.js"></script>
</body>
</html>