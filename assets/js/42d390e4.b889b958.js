"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[9263],{383:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var i=n(7462),o=(n(7294),n(3905));n(1839);const a={id:"backend-deployment",sidebar_position:3,title:"Backend deployment"},r=void 0,l={unversionedId:"infrastructure/backend-deployment",id:"infrastructure/backend-deployment",title:"Backend deployment",description:"Our backend is built with nest.js and runs its own process to handle incoming API requests",source:"@site/docs/infrastructure/backend-deployment.md",sourceDirName:"infrastructure",slug:"/infrastructure/backend-deployment",permalink:"/docs/infrastructure/backend-deployment",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"backend-deployment",sidebar_position:3,title:"Backend deployment"},sidebar:"tutorialSidebar",previous:{title:"Frontend deployment",permalink:"/docs/infrastructure/frontend-deployment"},next:{title:"Documentation deployment",permalink:"/docs/infrastructure/documentation-deployment"}},s={},p=[{value:"Deployment steps",id:"deployment-steps",level:2}],d={toc:p};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Our backend is built with ",(0,o.kt)("a",{parentName:"p",href:"https://nestjs.com/"},"nest.js")," and runs its own process to handle incoming API requests\nvia ",(0,o.kt)("inlineCode",{parentName:"p"},"npm run start:prod"),"."),(0,o.kt)("h2",{id:"deployment-steps"},"Deployment steps"),(0,o.kt)("p",null,"Deployment always happens when a push is sent to main. This triggers\nthe ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/gipfeli-io/gipfeli-api/blob/main/.github/workflows/deployment.yml"},"GitHub Action")," that performs\nthe following steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Run all the the steps in the ",(0,o.kt)("inlineCode",{parentName:"li"},"test-and-build")," job, consisting of",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Setting up a local Postgresql instance as a service to be used within the context of this build step"),(0,o.kt)("li",{parentName:"ol"},"Install dependencies and run unit tests and e2e tests (against the Postgresql instance from step 1). Tests are\nrun with coverage."),(0,o.kt)("li",{parentName:"ol"},"Merge coverage reports - because SonarCloud requires one single coverage\nfile, ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/gipfeli-io/gipfeli-api/tree/main#merging-coverage"},"the unit and e2e reports have to be merged"),"\nfor SonarCloud to be able to find them."),(0,o.kt)("li",{parentName:"ol"},"Run the SonarCloud scan to check the repository. In contrast to the frontend, this is done explicitly as an\naction, which is required by SonarCloud for running coverage analysis."),(0,o.kt)("li",{parentName:"ol"},"Set up the Docker image name as an environment variable, because the image name is different depending on the\nenvironment."),(0,o.kt)("li",{parentName:"ol"},"Build the container assigning it a unique name (",(0,o.kt)("inlineCode",{parentName:"li"},"gcr.io/{project_id}/{app_name}-{environment}:{commit_sha}"),")."),(0,o.kt)("li",{parentName:"ol"},"If we are pushing to either ",(0,o.kt)("inlineCode",{parentName:"li"},"stage")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"main"),":",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"establish connection to our Google Cloud account using the\nofficial ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/google-github-actions/auth"},"google-github-actions/auth")," step."),(0,o.kt)("li",{parentName:"ol"},"We can now use ",(0,o.kt)("inlineCode",{parentName:"li"},"gcloud")," tools. First, we configure the container registry."),(0,o.kt)("li",{parentName:"ol"},"We then push the image to the Google Cloud Container Registry"))))),(0,o.kt)("li",{parentName:"ol"},"Depending on whether we push to ",(0,o.kt)("inlineCode",{parentName:"li"},"stage")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"main"),", we run either the ",(0,o.kt)("inlineCode",{parentName:"li"},"deploy-stage")," or the ",(0,o.kt)("inlineCode",{parentName:"li"},"deploy-main")," job. They do\nthe same but use different endpoints to deploy the correct environment. This takes the following steps:",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Authenticate with Google Cloud again"),(0,o.kt)("li",{parentName:"ol"},"Deploy the previously pushed image using ",(0,o.kt)("inlineCode",{parentName:"li"},"gcloud run deploy")))),(0,o.kt)("li",{parentName:"ol"},"After this, the deployment starts, boots up our new image as a new CloudRun pod, performs healthchecks and gracefully\nreplaces the previous running pod with our new pod, redirecting all traffic to this pod. Because of the way our\nDockerfile is configured, it will also trigger database migrations (if any).")))}u.isMDXComponent=!0}}]);