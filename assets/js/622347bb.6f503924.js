"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[1408],{153:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var i=n(7462),a=(n(7294),n(3905));n(1839);const o={id:"frontend-deployment",sidebar_position:2,title:"Frontend deployment"},r=void 0,s={unversionedId:"infrastructure/frontend-deployment",id:"infrastructure/frontend-deployment",title:"Frontend deployment",description:"Our frontend is built with React using Create React App as a",source:"@site/docs/infrastructure/frontend-deployment.md",sourceDirName:"infrastructure",slug:"/infrastructure/frontend-deployment",permalink:"/docs/infrastructure/frontend-deployment",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"frontend-deployment",sidebar_position:2,title:"Frontend deployment"},sidebar:"tutorialSidebar",previous:{title:"Basics",permalink:"/docs/infrastructure/basics"},next:{title:"Backend deployment",permalink:"/docs/infrastructure/backend-deployment"}},l={},p=[{value:"Deployment steps",id:"deployment-steps",level:2},{value:"Todo",id:"todo",level:2}],d={toc:p};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Our frontend is built with ",(0,a.kt)("a",{parentName:"p",href:"https://reactjs.org/"},"React")," using ",(0,a.kt)("a",{parentName:"p",href:"https://create-react-app.dev/"},"Create React App")," as a\nskeleton builder. Currently, the build output is served via a lightweight ",(0,a.kt)("a",{parentName:"p",href:"https://www.nginx.com/"},"Nginx")," webserver."),(0,a.kt)("admonition",{title:"Why we're using Nginx to serve a static website",type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Given that a React app is built and only consists of static files (Javascript, CSS, HTML, etc.), there are several ways\nhow these files can be served. Using Nginx is the most straightforward approach since its a basic webserver that serves\nfiles and it comes with all amenities such as GZIP compression, routing and so on. "),(0,a.kt)("p",{parentName:"admonition"},"However, it could become more cost-efficient to drop Cloud Run and serve the files from a simple Storage Bucket. That\nwould require a Load Balancer, though, and at the moment the costs of adding a Load Balancer are far higher than using\nCloud Run.")),(0,a.kt)("h2",{id:"deployment-steps"},"Deployment steps"),(0,a.kt)("p",null,"Deployment always happens when a push is sent to main or stage. This triggers\nthe ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/gipfeli-io/gipfeli-frontend/blob/stage/.github/workflows/ci.yml"},"GitHub Action")," that\nperforms the following steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Run all the the steps in the ",(0,a.kt)("inlineCode",{parentName:"li"},"test-and-build")," job, consisting of",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"Run tests"),(0,a.kt)("li",{parentName:"ol"},"Configure the API URL"),(0,a.kt)("li",{parentName:"ol"},"Build the container assigning it a unique name (",(0,a.kt)("inlineCode",{parentName:"li"},"gcr.io/{project_id}/{app_name}:{commit_sha}"),")"),(0,a.kt)("li",{parentName:"ol"},"If we are pushing to either ",(0,a.kt)("inlineCode",{parentName:"li"},"stage")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"main"),":",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"establish connection to our Google Cloud account using the\nofficial ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/google-github-actions/auth"},"google-github-actions/auth")," step."),(0,a.kt)("li",{parentName:"ol"},"After step 1, we can now use ",(0,a.kt)("inlineCode",{parentName:"li"},"gcloud")," tools. First, we configure the container registry."),(0,a.kt)("li",{parentName:"ol"},"We then push the image to the Google Cloud Container Registry"))))),(0,a.kt)("li",{parentName:"ol"},"Depending on whether we push to ",(0,a.kt)("inlineCode",{parentName:"li"},"stage")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"main"),", we run either the ",(0,a.kt)("inlineCode",{parentName:"li"},"deploy-stage")," or the ",(0,a.kt)("inlineCode",{parentName:"li"},"deploy-main")," job. They do\nthe same but use different endpoints to deploy the correct environment. This takes the following steps:",(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"Authenticate with Google Cloud again"),(0,a.kt)("li",{parentName:"ol"},"Deploy the previously pushed image using ",(0,a.kt)("inlineCode",{parentName:"li"},"gcloud run deploy")))),(0,a.kt)("li",{parentName:"ol"},"After this, the deployment starts, boots up our new image, performs healthchecks and gracefully replaces the previous\nrunning pod with our new pod, redirecting all traffic to this pod.")),(0,a.kt)("h2",{id:"todo"},"Todo"),(0,a.kt)("ul",{className:"contains-task-list"},(0,a.kt)("li",{parentName:"ul",className:"task-list-item"},(0,a.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Change link to ",(0,a.kt)("inlineCode",{parentName:"li"},"main")," branch action when deployed to production")))}u.isMDXComponent=!0}}]);